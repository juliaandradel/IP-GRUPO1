#importando bibliotecas
import pygame as pg
from sys import exit
import time

#importando as classes que criamos
from classes_jogador import Tiro_Jogador
from classes_jogador import Jogador
from random import randint
from classes_inimigo import Inimigo
from classes_jogo import Tela_de_escolha, Lobby_fases
from classes_coletaveis import Vida_extra, Energetico, Trofeu

#iniciar o pygame
pg.init()

#fazendo existir uma tela
largura = 1280
altura = 720
tela = pg.display.set_mode((largura, altura))

#colocando o menu de escolha no nosso jogo
menu = Tela_de_escolha(tela)

#criando nosso personagem
player = pg.draw.rect(tela,'Blue',(640-16,360-16,32,32))

#declarando anteriormente as balas
balas_jogador = []

#declarando anteriormente os inimigos
inimigos = [Inimigo(tela, 2) for _ in range(5)]

#declarando ou criando os coletaveis
coletaveis_vida = []
energeticos = []
trofeu = Trofeu(tela, 1200, 360)
dado_coletaveis = randint(1, 100)

#criando o lobby de escolher a fase
lobby = Lobby_fases(tela)

inicializar_player_e_inimigos = True

#criando o campo, que Ã© quem vai se mover
campo = Jogador(tela,0,0,4000,4000,'Green',2,pg.K_w, pg.K_s, pg.K_a, pg.K_d)

#criando o relogio que dita a velocidade do jogo
fps = pg.time.Clock()

#inicializando o lobby de escolha de personagem
while menu.escolheu == False:
    #definindo a velocidade do jogo em 15 frames por segundo
    fps.tick(15)
    
    #permitindo fechar o jogo
    for event in pg.event.get():
        if event.type == pg.QUIT:
            pg.quit()
            exit()
            #fazendo as teclas se moverem
        menu.movimentacao_escolha(event)
    #dando a cor preta a tela
    tela.fill((0, 0, 0))
    
    menu.mostrar_texto()
    menu.triangulos_de_escolha()
    menu.mostrar_imagem()
    
    #manter a tela atuaizando
    pg.display.update()

while lobby.escolheu_fase == False:
    fps.tick(60)
    tela.fill('Dark green')
    for event in pg.event.get():
        if event.type == pg.QUIT:
            pg.quit()
            exit()

    campo.movimentacao()
    campo.update()
    lobby.movimentacao()
    lobby.renderizar_fases()
    if player.colliderect(lobby.area_fase1) or player.colliderect(
            lobby.area_fase2) or player.colliderect(lobby.area_fase3):
        lobby.escolheu_fase = True
        inicializar_player_e_inimigos = True
    player = pg.draw.rect(tela, 'Blue', (640-16, 360-16, 32, 32))
    pg.display.update()
    while lobby.escolheu_fase:
        if inicializar_player_e_inimigos:
            player.x = 100
            player.y = 100
            inimigos = [Inimigo(tela, 1) for _ in range(20)]
            inicializar_player_e_inimigos = False
        fps.tick(60)
        tela.fill('black')
        mouse_x, mouse_y = pg.mouse.get_pos()
        campo.interface()
        for event in pg.event.get():
            if event.type == pg.QUIT:
                pg.quit()
                exit()
            if event.type == pg.MOUSEBUTTONDOWN:
                if event.button == 1:
                    balas_jogador.append(Tiro_Jogador(player.x, player.y, mouse_x, mouse_y))

        campo.movimentacao()
        campo.update()
        player = pg.draw.rect(tela, 'Blue', (640-16,360-16, 32, 32))

        for bala in balas_jogador[:]:
            bala.update(tela)

            for inimigo in inimigos[:]:
                if inimigo.vivo and pg.Rect(inimigo.posicao_x, inimigo.posicao_y, 32, 32).collidepoint(bala.x, bala.y):
                    dado_coletaveis = randint(1, 100)
                    if dado_coletaveis <= 10:
                        qual_coletavel = randint(1, 2)
                        if qual_coletavel == 1:
                            coletaveis_vida.append(Vida_extra(tela, inimigo.posicao_x, inimigo.posicao_y))
                        elif qual_coletavel == 2:
                            energeticos.append(Energetico(tela, inimigo.posicao_x, inimigo.posicao_y))
                    inimigo.morrer()
                    inimigos.remove(inimigo)
                    balas_jogador.remove(bala)
                    break

        for inimigo in inimigos[:]:
            inimigo.movimentacao(player.x, player.y)

            if inimigo.rect.colliderect(player):
                inimigo.morrer()
                inimigos.remove(inimigo)
                campo.tomar_dano()

            inimigo.existir()

        for coletavel_vida in coletaveis_vida[:]:
            coletavel_vida.aparecer = True
            coletavel_vida.movimentacao()
            coletavel_vida.atualizar()
            if coletavel_vida.rect.colliderect(player) and coletavel_vida.aparecer:
                campo.recuperar_vida()
                coletaveis_vida.remove(coletavel_vida)
        for energetico in energeticos[:]:
            energetico.aparecer = True
            energetico.atualizar()
            if energetico.rect.colliderect(player) and energetico.aparecer:
                campo.tomar_energetico()
                energeticos.remove(energetico)
        if len(inimigos) == 0:
            trofeu.aparecer = True
            trofeu.atualizar()
            if trofeu.rect.colliderect(player) and trofeu.aparecer:
                campo.coletar_trofeu()
                trofeu.aparecer = False
                lobby.escolheu_fase = False

        pg.display.update()
